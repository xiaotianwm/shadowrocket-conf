[General]
bypass-system = true
skip-proxy = 192.168.0.0/16, 10.0.0.0/8, 172.16.0.0/12, localhost, *.local, captive.apple.com
tun-excluded-routes = 10.0.0.0/8, 100.64.0.0/10, 127.0.0.0/8, 169.254.0.0/16, 172.16.0.0/12, 192.0.0.0/24, 192.0.2.0/24, 192.88.99.0/24, 192.168.0.0/16, 198.51.100.0/24, 203.0.113.0/24, 224.0.0.0/4, 255.255.255.255/32
dns-server = system
ipv6 = true

[Rule]
# =========================================================
# 👻 幽灵直播 V22 - 纯净规则版
# 逻辑：先杀内鬼 -> 再放行组件(修复无网络) -> 最后全杀
# =========================================================

# --- 1. 【第一优先级：内鬼拦截】(必须放在最前面) ---
# 杀掉 hotapi (这是 Log13 里发现的漏网推流通道)
DOMAIN-KEYWORD, hotapi, REJECT
# 杀掉 cp-rp (这是伪装成图片的上传通道)
DOMAIN-KEYWORD, cp-rp, REJECT
# 杀掉 webcast-frontier (混合推送通道，有偷跑嫌疑)
DOMAIN-KEYWORD, webcast-frontier, REJECT
# 杀掉 RTC 和推流加速网关
DOMAIN-KEYWORD, rtc-access, REJECT
DOMAIN-KEYWORD, rtc-logger, REJECT
DOMAIN-KEYWORD, rtcpc, REJECT
DOMAIN-KEYWORD, rtc-sg, REJECT
DOMAIN-SUFFIX, live-netacc.tiktokv.com, REJECT

# --- 2. 【核心放行】恢复 App 功能 (修复“无网络/组件卡住”) ---
# [基础组件] 必须放行，否则开播界面卡住或提示无网络
DOMAIN-KEYWORD, gecko, PROXY
DOMAIN-KEYWORD, tnc, PROXY
DOMAIN-KEYWORD, vcs, PROXY
DOMAIN-KEYWORD, search, PROXY
DOMAIN-KEYWORD, oec, PROXY
DOMAIN-KEYWORD, jsb, PROXY
DOMAIN-KEYWORD, mssdk, PROXY
DOMAIN-SUFFIX, ibytedtos.com, PROXY

# [信令与API] 确保能进直播间、能发弹幕
DOMAIN-KEYWORD, webcast, PROXY
DOMAIN-SUFFIX, frontier.tiktokv.com, PROXY
DOMAIN-KEYWORD, api-h2, PROXY
DOMAIN-KEYWORD, api16, PROXY
DOMAIN-KEYWORD, api19, PROXY
DOMAIN-KEYWORD, api22, PROXY

# [第三方] 防止启动卡死
DOMAIN-SUFFIX, appsflyersdk.com, PROXY

# --- 3. 【图片资源放行】 ---
# 使用正则只允许 p+数字 开头的图片域名 (如 p16-sign...)
# 这样可以防止 cp-rp16 这种伪装域名混进来
DOMAIN-REGEX, ^p[0-9].*$, PROXY
DOMAIN-SUFFIX, ibyteimg.com, PROXY

# =========================================================
# ⛔ 【兜底猎杀区】(上面没放行的全是坏人)
# =========================================================

# 1. 杀掉所有视频 CDN (v3, v16, sf-teko 等)
# 因为上面已经放行了必要的图片，剩下的 tiktokcdn 几乎都是视频
DOMAIN-SUFFIX, tiktokcdn.com, REJECT
DOMAIN-SUFFIX, tiktokv.com, REJECT

# 2. 封死 80 端口 (防止 HTTP 直连 IP 偷跑)
AND, ((DEST-PORT,80)), REJECT

# 3. 封死所有 UDP (防止 RTC/QUIC 推流)
AND, ((PROTOCOL,UDP)), REJECT

# 4. 封死直连 IP (Log 历史记录中的推流 IP 段)
IP-CIDR, 38.60.0.0/16, REJECT
IP-CIDR, 128.1.0.0/16, REJECT
IP-CIDR, 71.18.0.0/16, REJECT
IP-CIDR, 156.238.0.0/16, REJECT
IP-CIDR, 122.10.0.0/16, REJECT
IP-CIDR, 45.197.0.0/16, REJECT
IP-CIDR, 162.128.0.0/16, REJECT
IP-CIDR, 149.104.0.0/16, REJECT
IP-CIDR, 122.155.0.0/16, REJECT
IP-CIDR, 198.18.0.0/15, REJECT

# =========================================================
# 🛡️ 常规规则
# =========================================================
DOMAIN-SUFFIX, local, DIRECT
IP-CIDR, 192.168.0.0/16, DIRECT
IP-CIDR, 10.0.0.0/8, DIRECT
IP-CIDR, 172.16.0.0/12, DIRECT
IP-CIDR, 127.0.0.0/8, DIRECT

# =========================================================
# ⛔ 终极兜底 (必须是 REJECT)
# =========================================================
# 只有匹配到上面白名单的才走代理，其他一切未知流量全部掐断
FINAL, REJECT
